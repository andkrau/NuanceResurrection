; Listing generated by Microsoft (R) Optimizing Compiler Version 14.00.50727.762 

	TITLE	c:\NuanceExperimental\comm.cpp
	.686P
	.XMM
	include listing.inc
	.model	flat

INCLUDELIB LIBCMTD
INCLUDELIB OLDNAMES

PUBLIC	?msgBuf@@3PADA					; msgBuf
PUBLIC	?commLogFile@@3PAU_iobuf@@A			; commLogFile
_BSS	SEGMENT
?msgBuf@@3PADA DB 0200H DUP (?)				; msgBuf
?commLogFile@@3PAU_iobuf@@A DD 01H DUP (?)		; commLogFile
_BSS	ENDS
_DATA	SEGMENT
__bad_alloc_Message DD FLAT:$SG12190
_DATA	ENDS
CONST	SEGMENT
$SG12190 DB	'bad allocation', 00H
CONST	ENDS
PUBLIC	?TriggerInterrupt@MPE@@QAEXI@Z			; MPE::TriggerInterrupt
PUBLIC	?DoCommBusController@@YAXXZ			; DoCommBusController
EXTRN	?SwapScalarBytes@@YIXPAI@Z:PROC			; SwapScalarBytes
EXTRN	?vdgCLUT@@3PAIA:BYTE				; vdgCLUT
EXTRN	?nuonEnv@@3PAVNuonEnvironment@@A:DWORD		; nuonEnv
EXTRN	__RTC_CheckEsp:PROC
EXTRN	__RTC_Shutdown:PROC
EXTRN	__RTC_InitBase:PROC
;	COMDAT ?target@?1??DoCommBusController@@YAXXZ@4IA
; File c:\nuanceexperimental\comm.cpp
_BSS	SEGMENT
?target@?1??DoCommBusController@@YAXXZ@4IA DD 01H DUP (?) ; `DoCommBusController'::`2'::target
_BSS	ENDS
;	COMDAT ?i@?1??DoCommBusController@@YAXXZ@4IA
_BSS	SEGMENT
?i@?1??DoCommBusController@@YAXXZ@4IA DD 01H DUP (?)	; `DoCommBusController'::`2'::i
_BSS	ENDS
;	COMDAT ?currentTransmitID@?1??DoCommBusController@@YAXXZ@4IA
_BSS	SEGMENT
?currentTransmitID@?1??DoCommBusController@@YAXXZ@4IA DD 01H DUP (?) ; `DoCommBusController'::`2'::currentTransmitID
_BSS	ENDS
;	COMDAT ?bPending@?1??DoCommBusController@@YAXXZ@4_NA
_BSS	SEGMENT
?bPending@?1??DoCommBusController@@YAXXZ@4_NA DB 01H DUP (?) ; `DoCommBusController'::`2'::bPending
_BSS	ENDS
;	COMDAT ?bLocked@?1??DoCommBusController@@YAXXZ@4_NA
_BSS	SEGMENT
?bLocked@?1??DoCommBusController@@YAXXZ@4_NA DB 01H DUP (?) ; `DoCommBusController'::`2'::bLocked
_BSS	ENDS
;	COMDAT rtc$TMZ
rtc$TMZ	SEGMENT
__RTC_Shutdown.rtc$TMZ DD FLAT:__RTC_Shutdown
rtc$TMZ	ENDS
;	COMDAT rtc$IMZ
rtc$IMZ	SEGMENT
__RTC_InitBase.rtc$IMZ DD FLAT:__RTC_InitBase
; Function compile flags: /Odtp /RTCsu
rtc$IMZ	ENDS
_TEXT	SEGMENT
tv260 = -16						; size = 4
tv247 = -12						; size = 4
_cmdValue$ = -4						; size = 4
?DoCommBusController@@YAXXZ PROC			; DoCommBusController

; 18   : {

	push	ebp
	mov	ebp, esp
	sub	esp, 16					; 00000010H
	mov	eax, -858993460				; ccccccccH
	mov	DWORD PTR [ebp-16], eax
	mov	DWORD PTR [ebp-12], eax
	mov	DWORD PTR [ebp-8], eax
	mov	DWORD PTR [ebp-4], eax

; 19   :   static uint32 currentTransmitID = 0;
; 20   :   static uint32 target;
; 21   :   uint32 cmdValue;
; 22   :   uint32 *clutPtr;
; 23   :   static uint32 i;
; 24   :   static bool bLocked;
; 25   :   static bool bPending;
; 26   : 
; 27   :   bLocked = false;

	mov	BYTE PTR ?bLocked@?1??DoCommBusController@@YAXXZ@4_NA, 0

; 28   :   bPending = false;

	mov	BYTE PTR ?bPending@?1??DoCommBusController@@YAXXZ@4_NA, 0

; 29   : 
; 30   :   if(!(nuonEnv->mpe[currentTransmitID]->commctl & COMM_LOCKED_BIT))

	mov	eax, DWORD PTR ?currentTransmitID@?1??DoCommBusController@@YAXXZ@4IA
	mov	ecx, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	edx, DWORD PTR [ecx+eax*4]
	mov	eax, DWORD PTR [edx+492]
	and	eax, 4096				; 00001000H
	jne	SHORT $LN27@DoCommBusC

; 31   :   {
; 32   :     for(i = 0; i < 4; i++)

	mov	DWORD PTR ?i@?1??DoCommBusController@@YAXXZ@4IA, 0
	jmp	SHORT $LN26@DoCommBusC
$LN25@DoCommBusC:
	mov	ecx, DWORD PTR ?i@?1??DoCommBusController@@YAXXZ@4IA
	add	ecx, 1
	mov	DWORD PTR ?i@?1??DoCommBusController@@YAXXZ@4IA, ecx
$LN26@DoCommBusC:
	cmp	DWORD PTR ?i@?1??DoCommBusController@@YAXXZ@4IA, 4
	jae	SHORT $LN24@DoCommBusC

; 33   :     {
; 34   :       if(nuonEnv->mpe[(currentTransmitID + i) & 0x03UL]->commctl & COMM_XMIT_BUFFER_FULL_BIT)

	mov	edx, DWORD PTR ?currentTransmitID@?1??DoCommBusController@@YAXXZ@4IA
	add	edx, DWORD PTR ?i@?1??DoCommBusController@@YAXXZ@4IA
	and	edx, 3
	mov	eax, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	ecx, DWORD PTR [eax+edx*4]
	mov	edx, DWORD PTR [ecx+492]
	and	edx, 32768				; 00008000H
	je	SHORT $LN23@DoCommBusC

; 35   :       {
; 36   :         currentTransmitID = (currentTransmitID + i) & 0x03UL;

	mov	eax, DWORD PTR ?currentTransmitID@?1??DoCommBusController@@YAXXZ@4IA
	add	eax, DWORD PTR ?i@?1??DoCommBusController@@YAXXZ@4IA
	and	eax, 3
	mov	DWORD PTR ?currentTransmitID@?1??DoCommBusController@@YAXXZ@4IA, eax

; 37   :         bPending = true;

	mov	BYTE PTR ?bPending@?1??DoCommBusController@@YAXXZ@4_NA, 1

; 38   :         break;

	jmp	SHORT $LN24@DoCommBusC
$LN23@DoCommBusC:

; 39   :       }
; 40   :     }

	jmp	SHORT $LN25@DoCommBusC
$LN24@DoCommBusC:

; 41   :   }
; 42   :   else

	jmp	SHORT $LN22@DoCommBusC
$LN27@DoCommBusC:

; 43   :   {
; 44   :     bLocked = true;

	mov	BYTE PTR ?bLocked@?1??DoCommBusController@@YAXXZ@4_NA, 1

; 45   :     bPending = (nuonEnv->mpe[currentTransmitID & 0x03UL]->commctl & COMM_XMIT_BUFFER_FULL_BIT);

	mov	ecx, DWORD PTR ?currentTransmitID@?1??DoCommBusController@@YAXXZ@4IA
	and	ecx, 3
	mov	edx, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	eax, DWORD PTR [edx+ecx*4]
	mov	ecx, DWORD PTR [eax+492]
	and	ecx, 32768				; 00008000H
	setne	dl
	mov	BYTE PTR ?bPending@?1??DoCommBusController@@YAXXZ@4_NA, dl
$LN22@DoCommBusC:

; 46   :   }
; 47   : 
; 48   :   if(!bPending)

	movzx	eax, BYTE PTR ?bPending@?1??DoCommBusController@@YAXXZ@4_NA
	test	eax, eax
	jne	SHORT $LN21@DoCommBusC

; 49   :   {
; 50   :     return;

	jmp	$LN28@DoCommBusC
$LN21@DoCommBusC:

; 51   :   }
; 52   : 
; 53   :   target = nuonEnv->mpe[currentTransmitID]->commctl & COMM_TARGET_ID_BITS;

	mov	ecx, DWORD PTR ?currentTransmitID@?1??DoCommBusController@@YAXXZ@4IA
	mov	edx, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	eax, DWORD PTR [edx+ecx*4]
	mov	ecx, DWORD PTR [eax+492]
	and	ecx, 255				; 000000ffH
	mov	DWORD PTR ?target@?1??DoCommBusController@@YAXXZ@4IA, ecx

; 54   : 
; 55   :   if(target < 4)

	cmp	DWORD PTR ?target@?1??DoCommBusController@@YAXXZ@4IA, 4
	jae	$LN20@DoCommBusC

; 56   :   {
; 57   :     if(!(nuonEnv->mpe[target]->commctl & COMM_DISABLED_BITS))

	mov	edx, DWORD PTR ?target@?1??DoCommBusController@@YAXXZ@4IA
	mov	eax, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	ecx, DWORD PTR [eax+edx*4]
	mov	edx, DWORD PTR [ecx+492]
	and	edx, -1073741824			; c0000000H
	jne	$LN19@DoCommBusC

; 58   :     {
; 59   :       nuonEnv->mpe[currentTransmitID]->commctl &= ~(COMM_XMIT_BUFFER_FULL_BIT);

	mov	eax, DWORD PTR ?currentTransmitID@?1??DoCommBusController@@YAXXZ@4IA
	mov	ecx, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	edx, DWORD PTR [ecx+eax*4]
	mov	eax, DWORD PTR [edx+492]
	and	eax, -32769				; ffff7fffH
	mov	ecx, DWORD PTR ?currentTransmitID@?1??DoCommBusController@@YAXXZ@4IA
	mov	edx, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	ecx, DWORD PTR [edx+ecx*4]
	mov	DWORD PTR [ecx+492], eax

; 60   :       nuonEnv->mpe[target]->commrecv0 = nuonEnv->mpe[currentTransmitID]->commxmit0;

	mov	edx, DWORD PTR ?currentTransmitID@?1??DoCommBusController@@YAXXZ@4IA
	mov	eax, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	ecx, DWORD PTR [eax+edx*4]
	mov	edx, DWORD PTR ?target@?1??DoCommBusController@@YAXXZ@4IA
	mov	eax, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	edx, DWORD PTR [eax+edx*4]
	mov	eax, DWORD PTR [ecx+496]
	mov	DWORD PTR [edx+512], eax

; 61   :       nuonEnv->mpe[target]->commrecv1 = nuonEnv->mpe[currentTransmitID]->commxmit1;

	mov	ecx, DWORD PTR ?currentTransmitID@?1??DoCommBusController@@YAXXZ@4IA
	mov	edx, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	eax, DWORD PTR [edx+ecx*4]
	mov	ecx, DWORD PTR ?target@?1??DoCommBusController@@YAXXZ@4IA
	mov	edx, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	ecx, DWORD PTR [edx+ecx*4]
	mov	edx, DWORD PTR [eax+500]
	mov	DWORD PTR [ecx+516], edx

; 62   :       nuonEnv->mpe[target]->commrecv2 = nuonEnv->mpe[currentTransmitID]->commxmit2;

	mov	eax, DWORD PTR ?currentTransmitID@?1??DoCommBusController@@YAXXZ@4IA
	mov	ecx, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	edx, DWORD PTR [ecx+eax*4]
	mov	eax, DWORD PTR ?target@?1??DoCommBusController@@YAXXZ@4IA
	mov	ecx, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	eax, DWORD PTR [ecx+eax*4]
	mov	ecx, DWORD PTR [edx+504]
	mov	DWORD PTR [eax+520], ecx

; 63   :       nuonEnv->mpe[target]->commrecv3 = nuonEnv->mpe[currentTransmitID]->commxmit3;

	mov	edx, DWORD PTR ?currentTransmitID@?1??DoCommBusController@@YAXXZ@4IA
	mov	eax, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	ecx, DWORD PTR [eax+edx*4]
	mov	edx, DWORD PTR ?target@?1??DoCommBusController@@YAXXZ@4IA
	mov	eax, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	edx, DWORD PTR [eax+edx*4]
	mov	eax, DWORD PTR [ecx+508]
	mov	DWORD PTR [edx+524], eax

; 64   :       nuonEnv->mpe[target]->comminfo &= 0xFFUL;

	mov	ecx, DWORD PTR ?target@?1??DoCommBusController@@YAXXZ@4IA
	mov	edx, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	eax, DWORD PTR [edx+ecx*4]
	mov	ecx, DWORD PTR [eax+488]
	and	ecx, 255				; 000000ffH
	mov	edx, DWORD PTR ?target@?1??DoCommBusController@@YAXXZ@4IA
	mov	eax, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	edx, DWORD PTR [eax+edx*4]
	mov	DWORD PTR [edx+488], ecx

; 65   :       nuonEnv->mpe[target]->comminfo |= (nuonEnv->mpe[currentTransmitID]->comminfo << 16);

	mov	eax, DWORD PTR ?target@?1??DoCommBusController@@YAXXZ@4IA
	mov	ecx, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	edx, DWORD PTR [ecx+eax*4]
	mov	eax, DWORD PTR ?currentTransmitID@?1??DoCommBusController@@YAXXZ@4IA
	mov	ecx, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	eax, DWORD PTR [ecx+eax*4]
	mov	ecx, DWORD PTR [eax+488]
	shl	ecx, 16					; 00000010H
	or	ecx, DWORD PTR [edx+488]
	mov	edx, DWORD PTR ?target@?1??DoCommBusController@@YAXXZ@4IA
	mov	eax, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	edx, DWORD PTR [eax+edx*4]
	mov	DWORD PTR [edx+488], ecx

; 66   :       nuonEnv->mpe[target]->commctl &= ~(COMM_SOURCE_ID_BITS);

	mov	eax, DWORD PTR ?target@?1??DoCommBusController@@YAXXZ@4IA
	mov	ecx, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	edx, DWORD PTR [ecx+eax*4]
	mov	eax, DWORD PTR [edx+492]
	and	eax, -16711681				; ff00ffffH
	mov	ecx, DWORD PTR ?target@?1??DoCommBusController@@YAXXZ@4IA
	mov	edx, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	ecx, DWORD PTR [edx+ecx*4]
	mov	DWORD PTR [ecx+492], eax

; 67   :       nuonEnv->mpe[target]->commctl |= (COMM_RECV_BUFFER_FULL_BIT | (currentTransmitID << 16));

	mov	edx, DWORD PTR ?target@?1??DoCommBusController@@YAXXZ@4IA
	mov	eax, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	ecx, DWORD PTR [eax+edx*4]
	mov	edx, DWORD PTR ?currentTransmitID@?1??DoCommBusController@@YAXXZ@4IA
	shl	edx, 16					; 00000010H
	or	edx, -2147483648			; 80000000H
	or	edx, DWORD PTR [ecx+492]
	mov	eax, DWORD PTR ?target@?1??DoCommBusController@@YAXXZ@4IA
	mov	ecx, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	eax, DWORD PTR [ecx+eax*4]
	mov	DWORD PTR [eax+492], edx

; 68   : 
; 69   :       nuonEnv->mpe[currentTransmitID]->TriggerInterrupt(INT_COMMXMIT);

	push	32					; 00000020H
	mov	ecx, DWORD PTR ?currentTransmitID@?1??DoCommBusController@@YAXXZ@4IA
	mov	edx, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	ecx, DWORD PTR [edx+ecx*4]
	call	?TriggerInterrupt@MPE@@QAEXI@Z		; MPE::TriggerInterrupt

; 70   :       nuonEnv->mpe[target]->TriggerInterrupt(INT_COMMRECV);

	push	16					; 00000010H
	mov	eax, DWORD PTR ?target@?1??DoCommBusController@@YAXXZ@4IA
	mov	ecx, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	ecx, DWORD PTR [ecx+eax*4]
	call	?TriggerInterrupt@MPE@@QAEXI@Z		; MPE::TriggerInterrupt

; 71   :       nuonEnv->pendingCommRequests--;

	mov	edx, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	eax, DWORD PTR [edx+44]
	sub	eax, 1
	mov	ecx, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	DWORD PTR [ecx+44], eax

; 72   : 
; 73   : #ifdef LOG_COMM
; 74   :       fprintf(commLogFile,"Comm packet sent: MPE%ld->MPE%ld, packet contents = {$%lx,$%lx,$%lx,$%lx, comminfo = $%lx\n",
; 75   :         currentTransmitID,
; 76   :         target,
; 77   :         nuonEnv->mpe[currentTransmitID]->commxmit0,
; 78   :         nuonEnv->mpe[currentTransmitID]->commxmit1,
; 79   :         nuonEnv->mpe[currentTransmitID]->commxmit2,
; 80   :         nuonEnv->mpe[currentTransmitID]->commxmit3,
; 81   :         nuonEnv->mpe[currentTransmitID]->comminfo);
; 82   :       fflush(commLogFile);
; 83   : #endif
; 84   :     }
; 85   :     else

	jmp	$LN18@DoCommBusC
$LN19@DoCommBusC:

; 86   :     {
; 87   :       //xmit failed
; 88   :       if(nuonEnv->mpe[currentTransmitID]->commctl & COMM_XMIT_RETRY_BIT)

	mov	edx, DWORD PTR ?currentTransmitID@?1??DoCommBusController@@YAXXZ@4IA
	mov	eax, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	ecx, DWORD PTR [eax+edx*4]
	mov	edx, DWORD PTR [ecx+492]
	and	edx, 8192				; 00002000H
	je	SHORT $LN17@DoCommBusC

; 89   :       {
; 90   : #ifdef LOG_COMM
; 91   :         fprintf(commLogFile,"Comm packet failed: MPE%ld->MPE%ld, will retry\n",currentTransmitID,target);
; 92   : #endif
; 93   :       }
; 94   :       else

	jmp	SHORT $LN18@DoCommBusC
$LN17@DoCommBusC:

; 95   :       {
; 96   :         //No Retry
; 97   : 
; 98   :         //Set Transmit Failed bit
; 99   :         nuonEnv->mpe[currentTransmitID]->commctl |= COMM_XMIT_FAILED_BIT;

	mov	eax, DWORD PTR ?currentTransmitID@?1??DoCommBusController@@YAXXZ@4IA
	mov	ecx, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	edx, DWORD PTR [ecx+eax*4]
	mov	eax, DWORD PTR [edx+492]
	or	eax, 16384				; 00004000H
	mov	ecx, DWORD PTR ?currentTransmitID@?1??DoCommBusController@@YAXXZ@4IA
	mov	edx, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	ecx, DWORD PTR [edx+ecx*4]
	mov	DWORD PTR [ecx+492], eax

; 100  :         //Clear Transmit Buffer full bit
; 101  :         nuonEnv->mpe[currentTransmitID]->commctl &= ~(COMM_XMIT_BUFFER_FULL_BIT);

	mov	edx, DWORD PTR ?currentTransmitID@?1??DoCommBusController@@YAXXZ@4IA
	mov	eax, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	ecx, DWORD PTR [eax+edx*4]
	mov	edx, DWORD PTR [ecx+492]
	and	edx, -32769				; ffff7fffH
	mov	eax, DWORD PTR ?currentTransmitID@?1??DoCommBusController@@YAXXZ@4IA
	mov	ecx, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	eax, DWORD PTR [ecx+eax*4]
	mov	DWORD PTR [eax+492], edx

; 102  :         nuonEnv->pendingCommRequests--;

	mov	ecx, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	edx, DWORD PTR [ecx+44]
	sub	edx, 1
	mov	eax, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	DWORD PTR [eax+44], edx
$LN18@DoCommBusC:

; 103  : 
; 104  : #ifdef LOG_COMM
; 105  :         fprintf(commLogFile,"Comm packet failed: MPE%ld->MPE%ld, no retry\n",currentTransmitID,target);
; 106  : #endif
; 107  :       }
; 108  :     }
; 109  :   }
; 110  :   else

	jmp	$LN15@DoCommBusC
$LN20@DoCommBusC:

; 111  :   {
; 112  :       //Reserved MPE ID or hardware target (eg audio)
; 113  : 
; 114  :       //Pretend the device received the packet
; 115  :       nuonEnv->mpe[currentTransmitID]->commctl &= (~COMM_XMIT_BUFFER_FULL_BIT);

	mov	ecx, DWORD PTR ?currentTransmitID@?1??DoCommBusController@@YAXXZ@4IA
	mov	edx, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	eax, DWORD PTR [edx+ecx*4]
	mov	ecx, DWORD PTR [eax+492]
	and	ecx, -32769				; ffff7fffH
	mov	edx, DWORD PTR ?currentTransmitID@?1??DoCommBusController@@YAXXZ@4IA
	mov	eax, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	edx, DWORD PTR [eax+edx*4]
	mov	DWORD PTR [edx+492], ecx

; 116  :       nuonEnv->mpe[currentTransmitID]->TriggerInterrupt(INT_COMMXMIT);

	push	32					; 00000020H
	mov	eax, DWORD PTR ?currentTransmitID@?1??DoCommBusController@@YAXXZ@4IA
	mov	ecx, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	ecx, DWORD PTR [ecx+eax*4]
	call	?TriggerInterrupt@MPE@@QAEXI@Z		; MPE::TriggerInterrupt

; 117  : 
; 118  :       if(target == COMM_ID_AUDIO)

	cmp	DWORD PTR ?target@?1??DoCommBusController@@YAXXZ@4IA, 67 ; 00000043H
	jne	SHORT $LN14@DoCommBusC

; 119  :       {
; 120  :         //audio target
; 121  :         cmdValue = nuonEnv->mpe[currentTransmitID]->commxmit0;

	mov	edx, DWORD PTR ?currentTransmitID@?1??DoCommBusController@@YAXXZ@4IA
	mov	eax, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	ecx, DWORD PTR [eax+edx*4]
	mov	edx, DWORD PTR [ecx+496]
	mov	DWORD PTR _cmdValue$[ebp], edx

; 122  :         switch(cmdValue >> 31)

	mov	eax, DWORD PTR _cmdValue$[ebp]
	shr	eax, 31					; 0000001fH
	mov	DWORD PTR tv247[ebp], eax
	cmp	DWORD PTR tv247[ebp], 1
	je	SHORT $LN10@DoCommBusC
	jmp	SHORT $LN12@DoCommBusC

; 123  :         {
; 124  :           case 0:
; 125  :             break;

	jmp	SHORT $LN12@DoCommBusC
$LN10@DoCommBusC:

; 126  :           case 1:
; 127  :             cmdValue &= 0x7FFFFFFF;

	mov	ecx, DWORD PTR _cmdValue$[ebp]
	and	ecx, 2147483647				; 7fffffffH
	mov	DWORD PTR _cmdValue$[ebp], ecx

; 128  :             if(cmdValue == 0x2C)

	cmp	DWORD PTR _cmdValue$[ebp], 44		; 0000002cH
	jne	SHORT $LN12@DoCommBusC

; 129  :             {
; 130  :               //write channel mode register: update NuonEnviroment variable only for now
; 131  :               //To do: modify SetChannelMode to recreate the sound buffer only if the new
; 132  :               //channel mode buffer size differs from the previous value.
; 133  :               nuonEnv->nuonAudioChannelMode = nuonEnv->mpe[currentTransmitID]->commxmit1;

	mov	edx, DWORD PTR ?currentTransmitID@?1??DoCommBusController@@YAXXZ@4IA
	mov	eax, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	ecx, DWORD PTR [eax+edx*4]
	mov	edx, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	eax, DWORD PTR [ecx+500]
	mov	DWORD PTR [edx+64], eax
$LN12@DoCommBusC:

; 134  :             }
; 135  :             break;
; 136  :         }
; 137  :       }
; 138  :       else if(target == COMM_ID_VDG)

	jmp	SHORT $LN8@DoCommBusC
$LN14@DoCommBusC:
	cmp	DWORD PTR ?target@?1??DoCommBusController@@YAXXZ@4IA, 65 ; 00000041H
	jne	SHORT $LN8@DoCommBusC

; 139  :       {
; 140  :         //vdg target
; 141  :         cmdValue = nuonEnv->mpe[currentTransmitID]->commxmit0;

	mov	ecx, DWORD PTR ?currentTransmitID@?1??DoCommBusController@@YAXXZ@4IA
	mov	edx, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	eax, DWORD PTR [edx+ecx*4]
	mov	ecx, DWORD PTR [eax+496]
	mov	DWORD PTR _cmdValue$[ebp], ecx

; 142  :         switch(cmdValue >> 31)

	mov	edx, DWORD PTR _cmdValue$[ebp]
	shr	edx, 31					; 0000001fH
	mov	DWORD PTR tv260[ebp], edx
	cmp	DWORD PTR tv260[ebp], 1
	je	SHORT $LN3@DoCommBusC
	jmp	SHORT $LN8@DoCommBusC

; 143  :         {
; 144  :           case 0:
; 145  :             break;

	jmp	SHORT $LN8@DoCommBusC
$LN3@DoCommBusC:

; 146  :           case 1:
; 147  :             cmdValue &= 0x7FFFFFFF;

	mov	eax, DWORD PTR _cmdValue$[ebp]
	and	eax, 2147483647				; 7fffffffH
	mov	DWORD PTR _cmdValue$[ebp], eax

; 148  :             if((cmdValue >= 0x200) && (cmdValue < 0x300))

	cmp	DWORD PTR _cmdValue$[ebp], 512		; 00000200H
	jb	SHORT $LN8@DoCommBusC
	cmp	DWORD PTR _cmdValue$[ebp], 768		; 00000300H
	jae	SHORT $LN8@DoCommBusC

; 149  :             {
; 150  :               //write VDG clut entry
; 151  :               vdgCLUT[cmdValue - 0x200] = nuonEnv->mpe[currentTransmitID]->commxmit1;

	mov	ecx, DWORD PTR ?currentTransmitID@?1??DoCommBusController@@YAXXZ@4IA
	mov	edx, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	eax, DWORD PTR [edx+ecx*4]
	mov	ecx, DWORD PTR _cmdValue$[ebp]
	mov	edx, DWORD PTR [eax+500]
	mov	DWORD PTR ?vdgCLUT@@3PAIA[ecx*4-2048], edx

; 152  :               SwapScalarBytes(&vdgCLUT[cmdValue - 0x200]);

	mov	eax, DWORD PTR _cmdValue$[ebp]
	lea	ecx, DWORD PTR ?vdgCLUT@@3PAIA[eax*4-2048]
	call	?SwapScalarBytes@@YIXPAI@Z		; SwapScalarBytes
$LN8@DoCommBusC:

; 153  :             }
; 154  :             break;
; 155  :         }
; 156  :       }
; 157  : 
; 158  :       nuonEnv->pendingCommRequests--;

	mov	ecx, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	edx, DWORD PTR [ecx+44]
	sub	edx, 1
	mov	eax, DWORD PTR ?nuonEnv@@3PAVNuonEnvironment@@A ; nuonEnv
	mov	DWORD PTR [eax+44], edx
$LN15@DoCommBusC:

; 159  :   }
; 160  : 
; 161  :   if(!bLocked)

	movzx	ecx, BYTE PTR ?bLocked@?1??DoCommBusController@@YAXXZ@4_NA
	test	ecx, ecx
	jne	SHORT $LN28@DoCommBusC

; 162  :   {
; 163  :     currentTransmitID = ((currentTransmitID + 1) & 0x03UL);

	mov	edx, DWORD PTR ?currentTransmitID@?1??DoCommBusController@@YAXXZ@4IA
	add	edx, 1
	and	edx, 3
	mov	DWORD PTR ?currentTransmitID@?1??DoCommBusController@@YAXXZ@4IA, edx
$LN28@DoCommBusC:

; 164  :   }
; 165  : }

	add	esp, 16					; 00000010H
	cmp	ebp, esp
	call	__RTC_CheckEsp
	mov	esp, ebp
	pop	ebp
	ret	0
?DoCommBusController@@YAXXZ ENDP			; DoCommBusController
_TEXT	ENDS
EXTRN	?Syscall_InterruptTriggered@@YAXPAVMPE@@@Z:PROC	; Syscall_InterruptTriggered
; Function compile flags: /Odtp /RTCsu
; File c:\nuanceexperimental\mpe.h
;	COMDAT ?TriggerInterrupt@MPE@@QAEXI@Z
_TEXT	SEGMENT
_this$ = -4						; size = 4
_which$ = 8						; size = 4
?TriggerInterrupt@MPE@@QAEXI@Z PROC			; MPE::TriggerInterrupt, COMDAT
; _this$ = ecx

; 481  :   {

	push	ebp
	mov	ebp, esp
	push	ecx
	mov	DWORD PTR [ebp-4], -858993460		; ccccccccH
	mov	DWORD PTR _this$[ebp], ecx

; 482  :     intsrc |= which;

	mov	eax, DWORD PTR _this$[ebp]
	mov	ecx, DWORD PTR [eax+420]
	or	ecx, DWORD PTR _which$[ebp]
	mov	edx, DWORD PTR _this$[ebp]
	mov	DWORD PTR [edx+420], ecx

; 483  :     Syscall_InterruptTriggered(this);

	mov	eax, DWORD PTR _this$[ebp]
	push	eax
	call	?Syscall_InterruptTriggered@@YAXPAVMPE@@@Z ; Syscall_InterruptTriggered
	add	esp, 4

; 484  :   }

	add	esp, 4
	cmp	ebp, esp
	call	__RTC_CheckEsp
	mov	esp, ebp
	pop	ebp
	ret	4
?TriggerInterrupt@MPE@@QAEXI@Z ENDP			; MPE::TriggerInterrupt
_TEXT	ENDS
END
